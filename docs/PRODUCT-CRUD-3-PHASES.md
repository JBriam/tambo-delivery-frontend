# CRUD de Productos en 3 Fases

Este documento explica el sistema de creaci√≥n de productos implementado en **3 fases independientes**, dise√±ado para facilitar la gesti√≥n de productos en Tambo Delivery.

## üìã √çndice

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Arquitectura](#arquitectura)
3. [Fase 1: Informaci√≥n B√°sica](#fase-1-informaci√≥n-b√°sica)
4. [Fase 2: Im√°genes y Recursos](#fase-2-im√°genes-y-recursos)
5. [Fase 3: Asignar Descuentos](#fase-3-asignar-descuentos)
6. [Flujo Completo](#flujo-completo)
7. [Endpoints del Backend](#endpoints-del-backend)
8. [Modelos de Datos](#modelos-de-datos)
9. [Uso y Ejemplos](#uso-y-ejemplos)

---

## üéØ Descripci√≥n General

El sistema CRUD de productos est√° dividido en **3 fases consecutivas**:

- **Fase 1**: Crear el producto con informaci√≥n b√°sica (obligatorio)
- **Fase 2**: Agregar im√°genes y recursos multimedia (opcional)
- **Fase 3**: Asignar descuentos existentes al producto (opcional)

Cada fase es **independiente** y puede ser omitida (excepto la Fase 1), permitiendo flexibilidad en el proceso de creaci√≥n.

---

## üèóÔ∏è Arquitectura

### Componentes Creados

```
src/app/features/admin/components/
‚îú‚îÄ‚îÄ product-create-phase1-modal.component.ts  # Modal Fase 1
‚îú‚îÄ‚îÄ product-create-phase2-modal.component.ts  # Modal Fase 2
‚îî‚îÄ‚îÄ product-create-phase3-modal.component.ts  # Modal Fase 3

src/app/features/admin/pages/
‚îî‚îÄ‚îÄ products-management.component.ts          # Gesti√≥n principal

src/app/models/
‚îî‚îÄ‚îÄ product.model.ts                          # Modelos actualizados

src/app/features/products/services/
‚îî‚îÄ‚îÄ product.service.ts                        # Servicio con nuevos endpoints
```

### Flujo de Estados

```
[Bot√≥n Crear] ‚Üí [Fase 1] ‚Üí [Fase 2] ‚Üí [Fase 3] ‚Üí [‚úì Completado]
                    ‚Üì           ‚Üì           ‚Üì
                  Guarda    Omitir      Omitir
                             ‚Üì           ‚Üì
                          [Fase 3] ‚Üí [‚úì Completado]
```

---

## üìù Fase 1: Informaci√≥n B√°sica

### Componente: `ProductCreatePhase1ModalComponent`

**Archivo**: `product-create-phase1-modal.component.ts`

### Campos del Formulario

| Campo | Tipo | Requerido | Descripci√≥n |
|-------|------|-----------|-------------|
| `name` | `string` | ‚úÖ S√≠ | Nombre del producto |
| `slug` | `string` | ‚úÖ S√≠ | URL amigable (auto-generada) |
| `description` | `textarea` | ‚úÖ S√≠ | Descripci√≥n detallada |
| `price` | `number` | ‚úÖ S√≠ | Precio en soles (S/) |
| `stock` | `number` | ‚úÖ S√≠ | Cantidad disponible |
| `brandId` | `UUID` | ‚úÖ S√≠ | ID de la marca |
| `categoryId` | `UUID` | ‚úÖ S√≠ | ID de la categor√≠a |
| `categoryTypeId` | `UUID` | ‚ùå No | ID del tipo de categor√≠a |
| `isNewArrival` | `boolean` | ‚ùå No | ¬øEs nuevo ingreso? |
| `isActive` | `boolean` | ‚ùå No | Estado activo/inactivo |

### Validaciones

- ‚úÖ Nombre no puede estar vac√≠o
- ‚úÖ Descripci√≥n es requerida
- ‚úÖ Precio debe ser mayor a 0
- ‚úÖ Stock no puede ser negativo
- ‚úÖ Marca y categor√≠a son obligatorias
- ‚úÖ Slug se auto-genera del nombre

### Funcionalidad

```typescript
// Al completar Fase 1
onPhase1Completed(productId: string) {
  this.newProductId = productId;
  this.isPhase1ModalOpen = false;
  this.isPhase2ModalOpen = true;  // Abre autom√°ticamente Fase 2
}
```

### Endpoint Backend

```http
POST /api/admin/products
Content-Type: application/json

{
  "slug": "coca-cola-500ml",
  "name": "Coca Cola 500ml",
  "description": "Bebida gaseosa...",
  "price": 3.50,
  "stock": 100,
  "brandId": "uuid-marca",
  "categoryId": "uuid-categoria",
  "categoryTypeId": "uuid-tipo-categoria",
  "isNewArrival": true,
  "isActive": true
}
```

---

## üñºÔ∏è Fase 2: Im√°genes y Recursos

### Componente: `ProductCreatePhase2ModalComponent`

**Archivo**: `product-create-phase2-modal.component.ts`

### Caracter√≠sticas

- ‚úÖ **Imagen Principal**: Obligatoria si se ingresa a esta fase
- ‚úÖ **Im√°genes Adicionales**: Ilimitadas (opcional)
- ‚úÖ **Vista Previa**: Muestra las im√°genes antes de guardar
- ‚úÖ **Tipos Soportados**: IMAGE, VIDEO
- ‚úÖ **Opci√≥n "Omitir"**: Saltar esta fase

### Estructura de un Recurso

```typescript
interface ProductResource {
  name: string;        // Nombre del recurso
  url: string;         // URL de la imagen/video
  isPrimary: boolean;  // ¬øEs la imagen principal?
  type: string;        // "IMAGE" | "VIDEO"
}
```

### Funcionalidad

```typescript
// Agregar recurso adicional
addAdditionalResource() {
  this.additionalResources.push({
    name: '',
    url: '',
    isPrimary: false,
    type: 'IMAGE'
  });
}

// Eliminar recurso
removeAdditionalResource(index: number) {
  this.additionalResources.splice(index, 1);
}

// Al completar Fase 2
onPhase2Completed() {
  this.isPhase2ModalOpen = false;
  this.isPhase3ModalOpen = true;  // Abre Fase 3
}
```

### Endpoint Backend

```http
POST /api/admin/products/{productId}/resources
Content-Type: application/json

{
  "resources": [
    {
      "name": "Imagen principal",
      "url": "https://example.com/coca-cola.jpg",
      "isPrimary": true,
      "type": "IMAGE"
    },
    {
      "name": "Vista lateral",
      "url": "https://example.com/coca-cola-side.jpg",
      "isPrimary": false,
      "type": "IMAGE"
    }
  ]
}
```

---

## üí∞ Fase 3: Asignar Descuentos

### Componente: `ProductCreatePhase3ModalComponent`

**Archivo**: `product-create-phase3-modal.component.ts`

### Caracter√≠sticas

- ‚úÖ Lista todos los descuentos **activos**
- ‚úÖ Selecci√≥n m√∫ltiple con checkboxes
- ‚úÖ Muestra informaci√≥n del descuento (porcentaje, fechas, estado)
- ‚úÖ Opci√≥n "Omitir": Finalizar sin asignar descuentos

### Informaci√≥n Mostrada

| Campo | Descripci√≥n |
|-------|-------------|
| Nombre | Nombre del descuento |
| Porcentaje | % de descuento (-15%, -20%, etc.) |
| Fechas | Fecha inicio - Fecha fin |
| Estado | Activo / Inactivo |

### Funcionalidad

```typescript
// Alternar selecci√≥n de descuento
toggleDiscount(discountId: string) {
  const index = this.selectedDiscountIds.indexOf(discountId);
  if (index > -1) {
    this.selectedDiscountIds.splice(index, 1);
  } else {
    this.selectedDiscountIds.push(discountId);
  }
}

// Al completar Fase 3
onPhase3Completed() {
  alert('‚úÖ Producto creado exitosamente');
  this.loadProducts();  // Recargar lista
}
```

### Endpoint Backend

```http
POST /api/admin/products/{productId}/discounts
Content-Type: application/json

{
  "discountIds": [
    "uuid-descuento-1",
    "uuid-descuento-2"
  ]
}
```

---

## üîÑ Flujo Completo

### Diagrama de Secuencia

```
Usuario                Modal Fase 1         Backend          Modal Fase 2         Modal Fase 3
   |                        |                  |                   |                    |
   |--[Crear Producto]----->|                  |                   |                    |
   |                        |                  |                   |                    |
   |   [Llenar Formulario]  |                  |                   |                    |
   |                        |                  |                   |                    |
   |<----[Validar]----------|                  |                   |                    |
   |                        |                  |                   |                    |
   |                        |--[POST /products]->                  |                    |
   |                        |<---[productId]---|                   |                    |
   |                        |                  |                   |                    |
   |                        |--[Abrir Fase 2]--------------------->|                    |
   |                        |                  |                   |                    |
   |   [Agregar Im√°genes]   |                  |                   |                    |
   |                        |                  |                   |                    |
   |                        |                  |<-[POST /resources]-|                   |
   |                        |                  |                   |                    |
   |                        |                  |                   |--[Abrir Fase 3]--->|
   |                        |                  |                   |                    |
   |   [Seleccionar Desc.]  |                  |                   |                    |
   |                        |                  |                   |                    |
   |                        |                  |<-[POST /discounts]---------------------|
   |                        |                  |                   |                    |
   |<---[‚úÖ Completado]------------------------------------------------------|
```

### C√≥digo de Integraci√≥n

```typescript
// En products-management.component.ts

export class ProductsManagementComponent {
  isPhase1ModalOpen = false;
  isPhase2ModalOpen = false;
  isPhase3ModalOpen = false;
  newProductId = '';

  // Iniciar creaci√≥n
  openCreateProductModal() {
    this.isPhase1ModalOpen = true;
  }

  // Fase 1 ‚Üí Fase 2
  onPhase1Completed(productId: string) {
    this.newProductId = productId;
    this.isPhase1ModalOpen = false;
    this.isPhase2ModalOpen = true;
  }

  // Fase 2 ‚Üí Fase 3
  onPhase2Completed() {
    this.isPhase2ModalOpen = false;
    this.isPhase3ModalOpen = true;
  }

  // Fase 3 ‚Üí Finalizar
  onPhase3Completed() {
    this.isPhase3ModalOpen = false;
    this.newProductId = '';
    alert('‚úÖ Producto creado exitosamente');
    this.loadProducts();
  }
}
```

---

## üåê Endpoints del Backend

### Resumen de Endpoints

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| `POST` | `/api/admin/products` | Crear producto b√°sico (Fase 1) |
| `POST` | `/api/admin/products/{id}/resources` | Agregar recursos (Fase 2) |
| `POST` | `/api/admin/products/{id}/discounts` | Asignar descuentos (Fase 3) |
| `DELETE` | `/api/admin/products/{id}/resources/{resourceId}` | Eliminar recurso |
| `DELETE` | `/api/admin/products/{id}/discounts/{discountId}` | Remover descuento |
| `PUT` | `/api/admin/products/{id}` | Actualizar producto |
| `DELETE` | `/api/admin/products/{id}` | Eliminar producto |
| `GET` | `/api/public/products` | Obtener productos (p√∫blico) |
| `GET` | `/api/admin/products` | Obtener todos (admin) |

### Detalles de los DTOs Backend

#### CreateProductDtoAdmin (Fase 1)
```java
@Data
public class CreateProductDtoAdmin {
    private String slug;
    private String name;
    private String description;
    private BigDecimal price;
    private Integer stock;
    private UUID brandId;
    private Boolean isNewArrival;
    private Boolean isActive;
    private UUID categoryId;
    private UUID categoryTypeId;
}
```

#### ResourceRequestDTO (Fase 2)
```java
@Data
public class ResourceRequestDTO {
    private String name;
    private String url;
    private Boolean isPrimary;
    private String type;  // "IMAGE" | "VIDEO"
}
```

#### AssignDiscountsDTO (Fase 3)
```java
@Data
public class AssignDiscountsDTO {
    private List<UUID> discountIds;
}
```

---

## üìä Modelos de Datos

### Frontend Models

```typescript
// product.model.ts

export interface Product {
  id: string;
  slug: string;
  name: string;
  description: string;
  price: number;
  stock: number;
  thumbnail?: string;
  brand: Brand;
  category: Category;
  categoryType?: CategoryType;
  resources?: ProductResource[];
  discounts?: Discount[];
  isNewArrival?: boolean;
  isActive: boolean;
  createdAt?: Date;
  updatedAt?: Date;
}

export interface ProductResource {
  id?: string;
  name: string;
  url: string;
  isPrimary: boolean;
  type: string;
}

export interface CreateProductBasicDto {
  slug: string;
  name: string;
  description: string;
  price: number;
  stock: number;
  brandId: string;
  categoryId: string;
  categoryTypeId?: string;
  isNewArrival: boolean;
  isActive: boolean;
}

export interface AddProductResourcesDto {
  resources: ProductResource[];
}

export interface AssignProductDiscountsDto {
  discountIds: string[];
}
```

---

## üé® Uso y Ejemplos

### Ejemplo 1: Crear producto completo

```typescript
// 1. Usuario hace clic en "Crear Producto"
openCreateProductModal();

// 2. Llena el formulario de Fase 1
{
  name: "Coca Cola 500ml",
  description: "Bebida gaseosa refrescante",
  price: 3.50,
  stock: 100,
  brandId: "uuid-coca-cola",
  categoryId: "uuid-bebidas",
  isNewArrival: true,
  isActive: true
}

// 3. Se crea el producto y se abre Fase 2
// productId: "uuid-nuevo-producto"

// 4. Agrega im√°genes
{
  resources: [
    { name: "Principal", url: "...", isPrimary: true, type: "IMAGE" },
    { name: "Lateral", url: "...", isPrimary: false, type: "IMAGE" }
  ]
}

// 5. Asigna descuentos en Fase 3
{
  discountIds: ["uuid-descuento-verano"]
}

// 6. ‚úÖ Producto creado exitosamente
```

### Ejemplo 2: Omitir fases opcionales

```typescript
// 1. Crea producto b√°sico (Fase 1)
createProductBasic(data);

// 2. Omite im√°genes (Fase 2)
onSkip(); // ‚Üí Abre Fase 3

// 3. Omite descuentos (Fase 3)
onSkip(); // ‚Üí Finaliza

// Resultado: Producto sin im√°genes ni descuentos
```

---

## üîß Servicios

### ProductService - Nuevos M√©todos

```typescript
export class ProductService {
  
  // FASE 1
  createProductBasic(data: CreateProductBasicDto): Observable<Product> {
    return this.http.post<Product>(`${API}/admin/products`, data);
  }

  // FASE 2
  addProductResources(
    productId: string, 
    data: AddProductResourcesDto
  ): Observable<Product> {
    return this.http.post<Product>(
      `${API}/admin/products/${productId}/resources`,
      data
    );
  }

  // FASE 3
  assignProductDiscounts(
    productId: string,
    data: AssignProductDiscountsDto
  ): Observable<Product> {
    return this.http.post<Product>(
      `${API}/admin/products/${productId}/discounts`,
      data
    );
  }

  // Eliminar recurso
  deleteProductResource(
    productId: string,
    resourceId: string
  ): Observable<any> {
    return this.http.delete(
      `${API}/admin/products/${productId}/resources/${resourceId}`
    );
  }

  // Remover descuento
  removeProductDiscount(
    productId: string,
    discountId: string
  ): Observable<any> {
    return this.http.delete(
      `${API}/admin/products/${productId}/discounts/${discountId}`
    );
  }
}
```

---

## ‚úÖ Checklist de Implementaci√≥n

### Frontend
- [x] Actualizar modelos en `product.model.ts`
- [x] Crear `ProductCreatePhase1ModalComponent`
- [x] Crear `ProductCreatePhase2ModalComponent`
- [x] Crear `ProductCreatePhase3ModalComponent`
- [x] Actualizar `ProductService` con nuevos endpoints
- [x] Integrar modales en `ProductsManagementComponent`

### Backend (Requerido)
- [ ] Endpoint `POST /api/admin/products` (Fase 1)
- [ ] Endpoint `POST /api/admin/products/{id}/resources` (Fase 2)
- [ ] Endpoint `POST /api/admin/products/{id}/discounts` (Fase 3)
- [ ] Endpoint `DELETE /api/admin/products/{id}/resources/{resourceId}`
- [ ] Endpoint `DELETE /api/admin/products/{id}/discounts/{discountId}`
- [ ] Validaciones y seguridad
- [ ] Tests unitarios

---

## üöÄ Pr√≥ximos Pasos

1. **Backend**: Implementar los endpoints seg√∫n los DTOs definidos
2. **Validaciones**: Agregar validaciones m√°s robustas
3. **Subida de Archivos**: Implementar subida directa de im√°genes
4. **Edici√≥n por Fases**: Permitir editar cada fase independientemente
5. **Preview**: Vista previa del producto antes de publicar
6. **Drag & Drop**: Ordenar im√°genes arrastrando

---

## üìû Soporte

Para dudas o problemas con la implementaci√≥n, revisar:
- Logs del navegador (F12 ‚Üí Console)
- Network tab para ver requests/responses
- Documentaci√≥n de Angular y RxJS

---

**Fecha de creaci√≥n**: Octubre 2025  
**Versi√≥n**: 1.0.0  
**Desarrollador**: Copilot AI Assistant
